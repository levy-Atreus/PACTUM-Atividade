name: CI e PublicaÃ§Ã£o de Resultados com Docker

on:
  push:
    branches: [ "main", "exercicios/modulo-4" ] 
  workflow_dispatch:

jobs:
  test_and_publish:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write 
      pages: write
      id-token: write

    steps:
    - name: â¬‡ï¸ Checkout do CÃ³digo
      uses: actions/checkout@v4

    # 1. ğŸ‹ NOVO: INSTALAR O DOCKER COMPOSE V2 (CORREÃ‡ÃƒO DO ERRO)
    - name: ğŸ‹ Setup Docker Buildx/Compose
      uses: docker/setup-buildx-action@v3
      
    # 2. ğŸš€ SUBIR SERVIÃ‡OS (USANDO COMANDO SEM HÃFEN)
    - name: ğŸš€ Subir ServiÃ§os com Docker Compose
      run: docker compose up -d # <-- Corrigido de docker-compose para docker compose

    - name: âš™ï¸ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20' 
        
    - name: ğŸ“¦ Instalar DependÃªncias
      run: npm install

    # 3. ğŸ§ª AGUARDAR E RODAR TESTES
    - name: ğŸ§ª Aguardar Servidor e Rodar Testes Pactum/Mocha
      run: |
        npm install -g wait-for-it
        wait-for-it localhost:3000 --timeout=50
        npm run test 

    # 4. ğŸ§¹ LIMPAR SERVIÃ‡OS (USANDO COMANDO SEM HÃFEN)
    - name: ğŸ§¹ Parar ServiÃ§os Docker
      if: always() 
      run: docker compose down # <-- Corrigido de docker-compose para docker compose