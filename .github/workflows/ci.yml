name: CI e PublicaÃ§Ã£o de Resultados com Docker

on:
  push:
    branches: [ "main", "exercicios/modulo-4" ] 
  workflow_dispatch:

jobs:
  test_and_publish:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write 
      pages: write
      id-token: write

    steps:
    - name: â¬‡ï¸ Checkout do CÃ³digo
      uses: actions/checkout@v4

    # 1. ETAPA CRÃTICA: LIGAR O DOCKER COM SERVICOS DE TESTE
    # Esta etapa irÃ¡ iniciar o ServeRest (3000) e qualquer outro serviÃ§o (8180)
    - name: ğŸš€ Subir ServiÃ§os com Docker Compose
      run: docker-compose up -d

    - name: âš™ï¸ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20' 
        
    - name: ğŸ“¦ Instalar DependÃªncias
      run: npm install

    # 2. ETAPA CRÃTICA: AGUARDAR O SERVIDOR FICAR PRONTO E RODAR OS TESTES
    # Usamos o 'wait-for-it' para garantir que a porta 3000 esteja respondendo
    - name: ğŸ§ª Aguardar Servidor e Rodar Testes Pactum/Mocha
      # Instalamos o 'wait-for-it' que pode ser usado para esperar a porta 3000
      run: |
        # Espera o ServeRest subir (50 segundos de timeout)
        npm install -g wait-for-it
        wait-for-it localhost:3000 --timeout=50
        
        # O Docker estÃ¡ rodando, entÃ£o executamos os testes diretamente
        npm run test 

    # 3. ETAPA CRÃTICA: PARAR E LIMPAR O DOCKER
    - name: ğŸ§¹ Parar ServiÃ§os Docker
      if: always() # Garante que rode mesmo que os testes falhem
      run: docker-compose down

    # Se vocÃª nÃ£o tiver publicaÃ§Ã£o de relatÃ³rio, remova o restante do Job.
    # ...